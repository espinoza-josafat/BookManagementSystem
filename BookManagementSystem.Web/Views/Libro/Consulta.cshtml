@{
    ViewBag.Title = "Consulta de Libros";
    Layout = "~/Views/Shared/_Layout.cshtml";
}

<div class="row">
    <div class="col-xs-12">
        <div class="col-md-12">
            <div class="box box-info">
                <div class="box-body">
                    <div class="row">
                        <div class="form-group col-md-4">
                            <label class="control-label" for="ISBN">ISBN</label>
                            <input type="text" class="form-control input-sm" id="ISBN" maxlength="13" onkeypress="soloNumerosKeyPress(event)" autocomplete="off" />
                        </div>

                        <div class="form-group col-md-8">
                            <label class="control-label" for="Titulo">Título</label>

                            <input type="text" class="form-control input-sm" id="Titulo" maxlength="1000" autocomplete="off" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="form-group col-md-4">
                            <label class="control-label" for="Editorial">Editorial</label>

                            <div class="input-group">
                                <input type="hidden" id="IdEditorial" />

                                <input type="text" class="form-control input-sm" id="Editorial" disabled="disabled" autocomplete="off" />

                                <span class="input-group-btn">
                                    <button class="btn btn-default input-sm" type="button" id="buttonRemoveEditorial" onclick="CleanInputsText(['IdEditorial', 'Editorial'])">
                                        <span class="glyphicon glyphicon-remove"></span>
                                    </button>
                                    <button class="btn btn-default input-sm" type="button" id="buttonFindEditorial" onclick="showModalFindEditorial()">
                                        <span class="glyphicon glyphicon-search"></span>
                                    </button>
                                </span>
                            </div>
                        </div>

                        <div class="form-group col-md-4">
                            <label class="control-label" for="Autor">Autor</label>
                            <div class="input-group">
                                <input type="hidden" id="IdAutor" />

                                <input type="text" class="form-control input-sm" id="Autor" disabled="disabled" autocomplete="off" />

                                <span class="input-group-btn">
                                    <button class="btn btn-default input-sm" type="button" id="buttonRemoveAutor" onclick="CleanInputsText(['IdAutor', 'Autor'])">
                                        <span class="glyphicon glyphicon-remove"></span>
                                    </button>
                                    <button class="btn btn-default input-sm" type="button" id="buttonFindAutor" onclick="showModalFindAutor()">
                                        <span class="glyphicon glyphicon-search"></span>
                                    </button>
                                </span>
                            </div>
                        </div>

                        <div class="form-group col-md-4">
                            <label class="control-label" for="Pais">País</label>

                            <select class="form-control input-sm" id="Pais"></select>
                        </div>
                    </div>

                    <div class="row">
                        <div class="form-group col-md-4">
                            <label class="control-label" for="Categoria">Categoría</label>
                            <div class="input-group">
                                <input type="hidden" id="IdCategoria" />

                                <input type="text" class="form-control input-sm" id="Categoria" disabled="disabled" autocomplete="off" />

                                <span class="input-group-btn">
                                    <button class="btn btn-default input-sm" type="button" id="buttonRemoveCategoria" onclick="CleanInputsText(['IdSubSubCategoria', 'SubSubCategoria', 'IdSubCategoria', 'SubCategoria', 'IdCategoria', 'Categoria'])">
                                        <span class="glyphicon glyphicon-remove"></span>
                                    </button>
                                    <button class="btn btn-default input-sm" type="button" id="buttonFindCategoria" onclick="showModalFindCategoria()">
                                        <span class="glyphicon glyphicon-search"></span>
                                    </button>
                                </span>
                            </div>
                        </div>

                        <div class="form-group col-md-4">
                            <label class="control-label" for="SubCategoria">Subcategoría</label>
                            <div class="input-group">
                                <input type="hidden" id="IdSubCategoria" />

                                <input type="text" class="form-control input-sm" id="SubCategoria" disabled="disabled" autocomplete="off" />

                                <span class="input-group-btn">
                                    <button class="btn btn-default input-sm" type="button" id="buttonRemoveSubcategoria" onclick="CleanInputsText(['IdSubSubCategoria', 'SubSubCategoria', 'IdSubCategoria', 'SubCategoria'])">
                                        <span class="glyphicon glyphicon-remove"></span>
                                    </button>
                                    <button class="btn btn-default input-sm" type="button" id="buttonFindSubcategoria" onclick="showModalFindSubCategoria()">
                                        <span class="glyphicon glyphicon-search"></span>
                                    </button>
                                </span>
                            </div>
                        </div>

                        <div class="form-group col-md-4">
                            <label class="control-label" for="SubSubCategoria">Subsubcategoría</label>
                            <div class="input-group">
                                <input type="hidden" id="IdSubSubCategoria" />

                                <input type="text" class="form-control input-sm" id="SubSubCategoria" disabled="disabled" autocomplete="off" />

                                <span class="input-group-btn">
                                    <button class="btn btn-default input-sm" type="button" id="buttonRemoveSubsubcategoria" onclick="CleanInputsText(['IdSubSubCategoria', 'SubSubCategoria'])">
                                        <span class="glyphicon glyphicon-remove"></span>
                                    </button>
                                    <button class="btn btn-default input-sm" type="button" id="buttonFindSubsubcategoria" onclick="showModalFindSubSubCategoria()">
                                        <span class="glyphicon glyphicon-search"></span>
                                    </button>
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="form-group col-md-4">
                            <label class="control-label" for="Tema">Tema</label>
                            <div class="input-group">
                                <input type="hidden" id="IdTema" />

                                <input type="text" class="form-control input-sm" id="Tema" disabled="disabled" autocomplete="off" />

                                <span class="input-group-btn">
                                    <button class="btn btn-default input-sm" type="button" id="buttonRemoveTema" onclick="CleanInputsText(['IdSubSubTema', 'SubSubTema', 'IdSubTema', 'SubTema', 'IdTema', 'Tema'])">
                                        <span class="glyphicon glyphicon-remove"></span>
                                    </button>
                                    <button class="btn btn-default input-sm" type="button" id="buttonFindTema" onclick="showModalFindTema()">
                                        <span class="glyphicon glyphicon-search"></span>
                                    </button>
                                </span>
                            </div>
                        </div>

                        <div class="form-group col-md-4">
                            <label class="control-label" for="SubTema">Subtema</label>
                            <div class="input-group">
                                <input type="hidden" id="IdSubTema" />

                                <input type="text" class="form-control input-sm" id="SubTema" disabled="disabled" autocomplete="off" />

                                <span class="input-group-btn">
                                    <button class="btn btn-default input-sm" type="button" id="buttonRemoveSubTema" onclick="CleanInputsText(['IdSubSubTema', 'SubSubTema', 'IdSubTema', 'SubTema'])">
                                        <span class="glyphicon glyphicon-remove"></span>
                                    </button>
                                    <button class="btn btn-default input-sm" type="button" id="buttonFindSubTema" onclick="showModalFindSubTema()">
                                        <span class="glyphicon glyphicon-search"></span>
                                    </button>
                                </span>
                            </div>
                        </div>

                        <div class="form-group col-md-4">
                            <label class="control-label" for="SubSubTema">Subsubtema</label>
                            <div class="input-group">
                                <input type="hidden" id="IdSubSubTema" />

                                <input type="text" class="form-control input-sm" id="SubSubTema" disabled="disabled" autocomplete="off" />

                                <span class="input-group-btn">
                                    <button class="btn btn-default input-sm" type="button" id="buttonRemoveSubSubTema" onclick="CleanInputsText(['IdSubSubTema', 'SubSubTema'])">
                                        <span class="glyphicon glyphicon-remove"></span>
                                    </button>
                                    <button class="btn btn-default input-sm" type="button" id="buttonFindSubSubTema" onclick="showModalFindSubSubTema()">
                                        <span class="glyphicon glyphicon-search"></span>
                                    </button>
                                </span>
                            </div>
                        </div>
                    </div>

                    <div class="row">
                        <div class="form-group col-md-4">
                            <label class="control-label" for="Idioma">Idioma</label>

                            <select class="form-control input-sm" id="Idioma"></select>
                        </div>

                        <div class="form-group col-md-4">
                            <label class="control-label" for="Anio">Año</label>

                            <input type="text" class="form-control input-sm" id="Anio" maxlength="4" onkeypress="soloNumerosKeyPress(event)" autocomplete="off" />
                        </div>

                        <div class="form-group col-md-4">
                            <label class="control-label" for="NumeroEdicion">Número de edición</label>

                            <input type="text" class="form-control input-sm" id="NumeroEdicion" maxlength="3" onkeypress="soloNumerosKeyPress(event)" autocomplete="off" />
                        </div>
                    </div>

                    <div class="row">
                        <div class="form-group col-md-12" style="text-align: right;">
                            <button type="button" class="btn btn-primary" onclick="findLibroConsulta()">
                                <span class="fa fa-search"></span> Buscar
                            </button>

                            <a href="@Url.Action("Edicion", "Libro")" class="btn btn-default">
                                <span class="fa fa-plus"></span> Agregar
                            </a>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-xs-12">
        <div class="col-md-12">
            <div class="box box-success">
                <div class="box-body table-responsive no-padding">
                    <table id="tblConsultaLibros" class="table table-bordered table-vmiddle">
                        <thead>
                            <tr>
                                <th data-column-id="titulo" data-type="string" data-width="80%">TÍTULO</th>
                                <th data-column-id="isbn" data-type="numeric" data-formatter="comandos" data-sortable="false" data-width="20%">ACCIÓN</th>
                            </tr>
                        </thead>
                        <tbody></tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@Html.Partial("_FindEditorial")
@Html.Partial("_FindAutor")
@Html.Partial("_FindCategoria")
@Html.Partial("_FindSubCategoria")
@Html.Partial("_FindSubSubCategoria")
@Html.Partial("_FindTema")
@Html.Partial("_FindSubTema")
@Html.Partial("_FindSubSubTema")

@section Scripts {
    <script>
        var _bootGridConsultaLibro = null;

        function CleanInputsText(inputs) {
            if (inputs && Array.isArray(inputs))
                for (var i = 0; i < inputs.length; i++)
                    $("#" + inputs[i]).val("");
        }

        function showModalFindEditorial() {
            mostrarModalFindEditorial(function (id, nombre) {
                $("#IdEditorial").val(id);
                $("#Editorial").val(nombre);
            });
        }

        function showModalFindAutor() {
            mostrarModalFindAutor(function (id, nombre) {
                $("#IdAutor").val(id);
                $("#Autor").val(nombre);
            });
        }

        function showModalFindCategoria() {
            mostrarModalFindCategoria(function (id, descripcion) {
                CleanInputsText(["IdSubSubCategoria", "SubSubCategoria", "IdSubCategoria", "SubCategoria"]);

                $("#IdCategoria").val(id);
                $("#Categoria").val(descripcion);
            });
        }

        function showModalFindSubCategoria() {
            if ($("#IdCategoria").val())
                mostrarModalFindSubCategoria(parseInt($("#IdCategoria").val()), function (id, descripcion) {
                    CleanInputsText(["IdSubSubCategoria", "SubSubCategoria"]);

                    $("#IdSubCategoria").val(id);
                    $("#SubCategoria").val(descripcion);
                });
        }

        function showModalFindSubSubCategoria() {
            if ($("#IdSubCategoria").val())
                mostrarModalFindSubSubCategoria(parseInt($("#IdSubCategoria").val()), function (id, descripcion) {
                    $("#IdSubSubCategoria").val(id);
                    $("#SubSubCategoria").val(descripcion);
                });
        }

        function showModalFindTema() {
            mostrarModalFindTema(function (id, descripcion) {
                CleanInputsText(["IdSubSubTema", "SubSubTema", "IdSubTema", "SubTema"]);

                $("#IdTema").val(id);
                $("#Tema").val(descripcion);
            });
        }

        function showModalFindSubTema() {
            if ($("#IdTema").val())
                mostrarModalFindSubTema(parseInt($("#IdTema").val()), function (id, descripcion) {
                    CleanInputsText(["IdSubSubTema", "SubSubTema"]);

                    $("#IdSubTema").val(id);
                    $("#SubTema").val(descripcion);
                });
        }

        function showModalFindSubSubTema() {
            if ($("#IdSubTema").val())
                mostrarModalFindSubSubTema(parseInt($("#IdSubTema").val()), function (id, descripcion) {
                    $("#IdSubSubTema").val(id);
                    $("#SubSubTema").val(descripcion);
                });
        }

        function findLibroConsulta() {
            var isbn = $("#ISBN").val().trim() ? ("isbn=" + encodeURI($("#ISBN").val().trim())) : "";
            var titulo = $("#Titulo").val().trim() ? ("titulo=" + encodeURI($("#Titulo").val().trim())) : "";
            var idEditorial = $("#IdEditorial").val().trim() ? ("idEditorial=" + encodeURI($("#IdEditorial").val().trim())) : "";
            var idAutor = $("#IdAutor").val().trim() ? ("idAutor=" + encodeURI($("#IdAutor").val().trim())) : "";
            var clavePais = $("#Pais").val().trim() ? ("clavePais=" + encodeURI($("#Pais").val().trim())) : "";
            var idCategoria = $("#IdCategoria").val().trim() ? ("idCategoria=" + encodeURI($("#IdCategoria").val().trim())) : "";
            var idSubCategoria = $("#IdSubCategoria").val().trim() ? ("idSubCategoria=" + encodeURI($("#IdSubCategoria").val().trim())) : "";
            var idSubSubCategoria = $("#IdSubSubCategoria").val().trim() ? ("idSubSubCategoria=" + encodeURI($("#IdSubSubCategoria").val().trim())) : "";
            var idTema = $("#IdTema").val().trim() ? ("idTema=" + encodeURI($("#IdTema").val().trim())) : "";
            var idSubTema = $("#IdSubTema").val().trim() ? ("idSubTema=" + encodeURI($("#IdSubTema").val().trim())) : "";
            var idSubSubTema = $("#IdSubSubTema").val().trim() ? ("idSubSubTema=" + encodeURI($("#IdSubSubTema").val().trim())) : "";
            var idIdioma = $("#Idioma").val().trim() ? ("idIdioma=" + encodeURI($("#Idioma").val().trim())) : "";
            var anio = $("#Anio").val().trim() ? ("anio=" + encodeURI($("#Anio").val().trim())) : "";
            var numeroEdicion = $("#NumeroEdicion").val().trim() ? ("numeroEdicion=" + encodeURI($("#NumeroEdicion").val().trim())) : "";

            var queryString = "";

            if (isbn)
                queryString = queryString ? (queryString + "&" + isbn) : isbn;
            if (titulo)
                queryString = queryString ? (queryString + "&" + titulo) : titulo;
            if (idEditorial)
                queryString = queryString ? (queryString + "&" + idEditorial) : idEditorial;
            if (idAutor)
                queryString = queryString ? (queryString + "&" + idAutor) : idAutor;
            if (clavePais)
                queryString = queryString ? (queryString + "&" + clavePais) : clavePais;
            if (idCategoria)
                queryString = queryString ? (queryString + "&" + idCategoria) : idCategoria;
            if (idSubCategoria)
                queryString = queryString ? (queryString + "&" + idSubCategoria) : idSubCategoria;
            if (idSubSubCategoria)
                queryString = queryString ? (queryString + "&" + idSubSubCategoria) : idSubSubCategoria;
            if (idTema)
                queryString = queryString ? (queryString + "&" + idTema) : idTema;
            if (idSubTema)
                queryString = queryString ? (queryString + "&" + idSubTema) : idSubTema;
            if (idSubSubTema)
                queryString = queryString ? (queryString + "&" + idSubSubTema) : idSubSubTema;
            if (idIdioma)
                queryString = queryString ? (queryString + "&" + idIdioma) : idIdioma;
            if (anio)
                queryString = queryString ? (queryString + "&" + anio) : anio;
            if (numeroEdicion)
                queryString = queryString ? (queryString + "&" + numeroEdicion) : numeroEdicion;
            
            if (queryString)
                queryString = "?" + queryString;

            AjaxGetNoCacheJsonAsync(
                baseUrl + "Api/Libro/Consultar" + queryString,
                function (data) {
                    if (data && Array.isArray(data) && data.length > 0)
                        _bootGridConsultaLibro.bootgrid("append", data);
                }, null, function () {
                    if (mostrarOverlayLoading && typeof (mostrarOverlayLoading) === "function")
                        mostrarOverlayLoading(true);

                    _bootGridConsultaLibro.bootgrid("clear");
                }, null);
        }

        $(document).ready(function () {
            $("#Pais, #Idioma").append("<option value=''>-- Cualquiera --</option>");

            AjaxGetNoCacheJsonAsync(
                baseUrl + "Api/Pais/Obtener",
                function (data) {
                    if (data && Array.isArray(data) && data.length > 0) {
                        $.each(data, function (index, item) {
                            $("#Pais").append("<option value='" + item.clave + "'>" + item.nombre + "</option>");
                        });
                    }
                }, function (data) { }, function () { }, function () { });

            AjaxGetNoCacheJsonAsync(
                baseUrl + "Api/Idioma/Obtener",
                function (data) {
                    if (data && Array.isArray(data) && data.length > 0) {
                        $.each(data, function (index, item) {
                            $("#Idioma").append("<option value='" + item.id + "'>" + item.descripcion + "</option>");
                        });
                    }
                }, function (data) { }, function () { }, function () { });

            _bootGridConsultaLibro = $("#tblConsultaLibros").bootgrid({
                formatters: {
                    comandos: function (column, row) {
                        return "<a href='@Url.Action("Edicion", "Libro")?isbn=" + row.isbn + "' class='btn btn-success' style='margin-right: 30px; width: 100px;'><span class='fa fa-pencil'></span> Modificar</a>";
                    }
                },
                labels: {
                    all: "Todo",
                    infos: "Mostrando de {{ctx.start}} a {{ctx.end}} registros de {{ctx.total}}",
                    loading: "Cargando...",
                    noResults: "No se encontraron registros",
                    refresh: "Actualizar",
                    search: "Buscar",
                }
            });
        });
    </script>
}